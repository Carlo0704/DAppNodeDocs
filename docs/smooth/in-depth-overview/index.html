<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-smooth/in-depth-overview">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">General Overview | Dappnode</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.dappnode.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.dappnode.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://docs.dappnode.io/docs/smooth/in-depth-overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="General Overview | Dappnode"><meta data-rh="true" name="description" content="In this page, you will find an in-depth explanation on how Smooth works. This includes the different components of Smooth, all states possible of a subscribed Smooth validator, and much more!"><meta data-rh="true" property="og:description" content="In this page, you will find an in-depth explanation on how Smooth works. This includes the different components of Smooth, all states possible of a subscribed Smooth validator, and much more!"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://docs.dappnode.io/docs/smooth/in-depth-overview"><link data-rh="true" rel="alternate" href="https://docs.dappnode.io/docs/smooth/in-depth-overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.dappnode.io/docs/smooth/in-depth-overview" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Dappnode RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Dappnode Atom Feed"><link rel="stylesheet" href="/assets/css/styles.3b556d45.css">
<link rel="preload" href="/assets/js/runtime~main.61229165.js" as="script">
<link rel="preload" href="/assets/js/main.a3e4ec34.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Dappnode Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Dappnode Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Dappnode Docs</b></a><a class="navbar__item navbar__link" href="/docs/user/getting-started/choose-your-path">User Docs</a><a class="navbar__item navbar__link" href="/docs/dev">Dev Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/smooth">Smooth</a><a class="navbar__item navbar__link" href="/docs/dao">DAO</a></div><div class="navbar__items navbar__items--right"><a href="https://dappnode.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Dappnode<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/dappnode/DappnodeDocs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/smooth">Smooth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/smooth/in-depth-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/smooth/subscribe-to-smooth/overview">Subscribe to Smooth!</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/smooth/unsubscribe-from-smooth">Unsubscribe from Smooth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/smooth/faq-glossary">FAQ / Glossary</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Overview</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>General Overview</h1><p>In this page, you will find an in-depth explanation on how Smooth works. This includes the different components of Smooth, all states possible of a subscribed Smooth validator, and much more! </p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>We recommend reading and understanding the contents of this page before subscribing to Smooth.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-parameters">Configuration parameters<a href="#configuration-parameters" class="hash-link" aria-label="Direct link to Configuration parameters" title="Direct link to Configuration parameters">​</a></h2><p>The smoothing pool shall contain the following configuration parameters:</p><ul><li><code>COLLATERAL_GWEI</code>: Amount of collateral in gwei that a validator need to join the pool.</li><li><code>DEPLOYED_SLOT</code>: Slot when the smoothing pool contract was deployed.</li><li><code>CHECKPOINT_SIZE_SLOTS</code>: How often the smart contract root is updated with new rewards, in slots.</li><li><code>OWNER_ADDRESS</code>: Set of addresses with <code>0x</code> prefix that are allowed to update the smoothing pool contract.</li><li><code>QUORUM</code>: Amount of <code>OWNER_ADDRESS</code> that have to agree on the merkle root before it&#x27;s considered consolidated. As an example this number could be 3/4, where 4 addresses are allowed to update the root and 3 of them have to agree.</li><li><code>POOL_CONTRACT_ADDRESS</code>: Address with <code>0x</code> prefix of the smoothing pool contract.</li><li><code>NETWORK</code>: Network where rewards are being calculated: <code>mainnet</code> or <code>goerli</code>.</li><li><code>POOL_FEES_ADDRESS</code>: Address with <code>0x</code> prefix of the account that can claim the smoothing pool fees.</li><li><code>POOL_FEES_PERCENT</code>: Amount in % (scaled by 100) that <code>POOL_FEES_ADDRESS</code> gets for every reward sent to the smoothing pool. Note that it also gets rounding remainders on top, but this is almost neglectable.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="smooths-source-of-rewards">Smooth&#x27;s source of rewards<a href="#smooths-source-of-rewards" class="hash-link" aria-label="Direct link to Smooth&#x27;s source of rewards" title="Direct link to Smooth&#x27;s source of rewards">​</a></h2><p>A <code>Reward</code> is considered to be any balance denominated in Eth that is sent to the <code>POOL_CONTRACT_ADDRESS</code>. These are detected by the oracle and shared fairly among all the participants in the pool at a given time. The oracle shall detect all these types of rewards and distribute them fairly (see rewards calculation section). All of these rewards are denominated in <code>ETH</code> and other types of tokens such as ERC20 are not considered by the oracle:</p><ul><li><code>MevBlock</code>: Comes from a block proposal where the reward was obtained via an off-chain agreement using tools such as mev-boost, usually coming as the last transaction in the block.</li><li><code>VanilaBlock</code>: Comes from a block proposal where no MEV relays participated.</li><li><code>Donation</code>: Any address can send an arbitrary amount, either via an Eth tx or via a smart contract to the pool.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subscribeunsubscribeban">Subscribe/unsubscribe/ban<a href="#subscribeunsubscribeban" class="hash-link" aria-label="Direct link to Subscribe/unsubscribe/ban" title="Direct link to Subscribe/unsubscribe/ban">​</a></h2><p>Only the following validators can subscribe into the pool:</p><ul><li>Validators in active state (not exiting nor slashed). Validators with a wrong state will be ignored.</li><li>Validators with eth1 withdrawal credentials. Validators with BLS credentials will be ignored.</li></ul><p>Rewards are only shared among subscribed participants in the pool. Hereunder it&#x27;s explained the different ways in which a validator can join or leave the pool. Joining can be done with manual or automatatic subscription. And leaving can be done by unsubscribing to the pool or by being banned from it.</p><p><strong>Subscribing</strong> to the pool:</p><ul><li><code>Automatic Subscription</code>: If any validator sends a <code>MevBlock</code> or <code>VanilaBlock</code> reward to the smoothing pool contract <code>POOL_CONTRACT_ADDRESS</code> it is considered automatically subscribed into the pool, and will start accruing rewards from that moment. This type of subscription doesn&#x27;t require any collateral or lock up of funds, since by successfully proposing a block with the correct fee recipient, we consider that this validator has enough skin in the game. However, since block proposals are a rare event, it can take weeks or even months for a validator to get automatically subscribed. This is not ideal because it won&#x27;t be leveraging the benefits of the smoothing pool during this time.</li><li><code>Manual Subscription</code>: On the other hand, a validator can start earning rewards from the very beginning if it adds <code>COLLATERAL_GWEI</code> amount as collateral. This collateral can be deposited by calling the register function in the oracle smart contract. This type of subscription allows the validator to start earning rewards without having to wait weeks or months until a proposal is detected. A subscription is only considered valid if:<ul><li><code>collateral&gt;=COLLATERAL_GWEI</code></li><li>The <code>validatorIndex</code> included is the transaction</li><li>The account that sent the transaction matches the <code>validatorIndex</code> withdrawal credentials.</li></ul></li></ul><p>Note that the collateral that a validator deposits via its withdrawal address is added to the validator <code>PendingRewards</code>. This means that it is returned after the first valid block proposal. In other words, the pool doesnt get the collateral, it just blocks it until the validator proposes a block. See <code>PendingRewards</code>, <code>AccumulatedRewards</code> down below. Note also that if by mistake a validator deposits the colateral twice, the second one is also returned.</p><p><strong>Unsubscribing</strong> from the pool:</p><ul><li><code>Unsubscribe</code>: Similarly, the oracle shall detect the following event from the smoothing pool smart contract, which signals that a given <code>validatorIndex</code> was unsubscribed from the pool. Note that the unsubscription is only considered valid if the <code>sender</code> matches the validator withdrawal address.</li></ul><p><strong>Banning</strong> from the pool:</p><ul><li>The oracle shall detect if an active validator in the smoothing pool proposed a block with a <code>fee_recipieint</code> different than <code>POOL_CONTRACT_ADDRESS</code>. This means that this validator sent its reward to a different address, so we consider this misbehaving and the validator will be banned forever from the smoothing pool.</li></ul><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Comprehending the purpose of the fee recipient and why it&#x27;s vital for validators not to change it while subscribed to Smooth is crucial. Modifying a validator&#x27;s fee recipient to an address that is not Smooth&#x27;s and proposing a block with it while being subscribed to the pool constitutes misconduct. Such behavior will lead to the validator being banned from participating in the pool.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state-machine">State machine<a href="#state-machine" class="hash-link" aria-label="Direct link to State machine" title="Direct link to State machine">​</a></h2><p>The oracle uses the following <strong>state machine</strong> to track the status of the different validators that are subscribed to Smooth. Different actions can trigger a state change and in the following image all possible transitions are described.</p><p><img loading="lazy" src="https://github.com/dappnode/mev-sp-oracle/blob/main/spec/states.png?raw=true" alt="statemachine" class="img_ev3q"></p><p>There are 5 different states a validator can have:</p><ul><li><code>Active</code>: A validator is active and subscribed to the pool, earning rewards over the time.</li><li><code>YellowCard</code>: The validator missed only its last block proposal, but still earns rewards.</li><li><code>RedCard</code>: The validator missed two block proposals in a row. In this state the validator does not earn rewards until a valid block has been proposed by it.</li><li><code>NotSubscribed:</code> The validator is no longer subscribed to the pool, but still tracked by the validator. For example, a validator that unsubscribed. Note that this is still tracked because a validator can unsubscribe but it may still have pending balance to claim. In this state the validator does not earn rewards.</li><li><code>Banned</code>: The validator is banned forever from the pool. <strong>A validator is banned when its subscribed to the pool but proposes a block with the wrong fee recipient</strong>.</li><li><code>Untracked</code>: The validator is not tracked by the pool. It never subscribed before nor has any active subscription.</li></ul><p>And 6 different actions can trigger a state transition:</p><ul><li><code>ProposalOk</code>: The validator proposed a valid block with its rewards correctly sent to the smoothing pool address.</li><li><code>ProposalMissed</code>: The validator should have proposed a block but missed its proposal.</li><li><code>ProposalWrongFee</code>: The validator proposes a block but with a wrong fee recipient.</li><li><code>ManualSubscription</code>: The validator manually subscribes to the pool, depositing collateral for its validator index by calling the smart contract function (see event).</li><li><code>AutoSubscription</code>: The validator is automatically subscribed to the pool, by setting as fee recipient the smoothing pool address.</li><li><code>Unsubscribe</code>: The validator manually unsubscribes to the pool, calling the unsubscribe function from the smart contract (see event).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rewards-calculation">Rewards calculation<a href="#rewards-calculation" class="hash-link" aria-label="Direct link to Rewards calculation" title="Direct link to Rewards calculation">​</a></h2><p>When a validator has an active subscription to the pool (<code>Active</code> or <code>YellowCard</code> state) it is eligible for rewards, meaning that it will receive a given share of each reward that is sent to the pool. Validators in <code>RedCard</code> are considered subscribed, but don&#x27;t earn rewards until they become active again.</p><p>There are two <strong>sources of rewards</strong>:</p><ul><li>Block proposals (execution layer rewards earned via tips or MEV), see <code>MevBlock</code> or <code>VanilaBlock</code>.</li><li>Donations by any user that sends an arbitrary amount of Eth balance to the contract, see <code>PayableDonation</code> or <code>NonPayableDonation</code>.</li></ul><p>With the incoming rewards to the pool, the oracle calculates two different types of validator rewards:</p><ul><li><code>AccumulatedRewards</code>: This rewards are already consolidated, meaning that they can be claimed at any time, by submitting a valid proof to the smart contract. This assumes that a <code>CHECKPOINT_SIZE_SLOTS</code> has been reached, and rewards are ready to be claimed onchain.</li><li><code>PendingRewards</code>: This rewards are not <em>consolidated</em> yet, meaning that they belong to the validator but they can be claimed, until a valid block proposal is sent to the smoothing pool.</li></ul><p>It&#x27;s defined as <strong>consolidate balance</strong> when a validator proposes a block whose fee recipient address is correctly sent to the smoothing pool (<code>POOL_CONTRACT_ADDRESS</code> address). When a validator consolidates its rewards, all its <code>PendingRewards</code> are added to its <code>AccumulatedRewards</code>, meaning that what was pending is now ready to claim at any time. Note also that after performing this operation the <code>PendingRewards</code> are reset. So consolidating can be seen as a way of converting the <code>Pending</code> into <code>Accumulated</code>.</p><p>All validator rewards are updated on every <strong>finalized</strong> block that is added to the chain. It is important to highlight that it is only done on finalized blocks, since this implies that the block is non-reversable and no reorgs are possible at this point (unless something major happens).</p><p>When calculating the rewards, the pool operator takes a cut for each reward that is sent to the pool, where <code>POOL_FEES_ADDRESS</code> gets <code>POOL_FEES_PERCENT</code>. The rest of the rewards are shared evenly among all eligible validators. This value shall not be higher than 100% and its stored as scaled by x100, which allows to have two decimal points.</p><p>Regarding the pool fees, note that the funds are not sent <em>per se</em> to the <code>POOL_FEES_ADDRESS</code> but they are added as a leaf in the merkle tree (see merkle tree section). In other words, the owner of the pool can claim the fees as if it were a validator, by providing a valid merkle proof and using said address as sender.</p><p>For each reward (see types of rewards) that is sent to the pool on a finalized block, it is distributed as follows:</p><ul><li>Get the amount of eligible validators (validators that are eligible for rewards) <code>Active</code> or <code>YellowCard</code> state.</li><li>The pool takes <code>POOL_FEES_PERCENT</code> of that reward, increasing its balance <code>AccumulatedRewards</code> by that amount + remainder (if any). Note that all the arithmetic is integer based without decimals, hence the remainder.</li><li>The reward minus the cut (and the remainder) is shared among all eligible validators. Note that if there is also a reminder, it goes to the <code>POOL_FEES_ADDRESS</code>, increasing its <code>AccumulatedRewards</code>.</li><li>Each eligible validator gets its <code>PendingRewards</code> increased by that amount.</li><li>If the reward comes from a block proposal, the validator gets its <code>AccumulatedRewards</code> consolidated, since it has proven that is participating in the pool.</li></ul><p>Note that the pool gets the remainders from two different divisions, but this is done for simplicity and since the calculations are in wei, the value of it is neglectable. Doing this makes the oracle fair with all validators, since each one of them gets the exact same amount of rewards. So in practice, <code>POOL_FEES_ADDRESS</code> just gets <code>POOL_FEES_PERCENT</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="merkle-trees-and-proofs">Merkle trees and proofs<a href="#merkle-trees-and-proofs" class="hash-link" aria-label="Direct link to Merkle trees and proofs" title="Direct link to Merkle trees and proofs">​</a></h2><p>Since storing all rewards calculations on-chain would be almost impossible and very expensive, merkle trees are used to summarize the state of all validators tracked by the oracle in a given value called *<em>merkle root</em>. All the computation of the rewards is done off-chain by the oracle, and on every <code>CHECKPOINT_SIZE_SLOTS</code> all rewards all calculated and summarized in a new merkle root that is stored on-chain in Ethereum.</p><p>Each leaf of the tree contains two values, the withdrawal address and the accumulated balance. Note that in order to be more gas efficient and allow to claim of multiple validators in just one transactions, all validators belonging to the same withdrawal address are aggregated.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> RawLeaf </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WithdrawalAddress     </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AccumulatedBalance </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">big</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://github.com/dappnode/mev-sp-oracle/blob/main/spec/merkles.png?raw=true" alt="trees" class="img_ev3q"></p><ul><li>The merkle tree leafs are ordered by its deposit address in ascending order.</li><li>The merkle tree is prepended (first element) with a leaf containing <code>POOL_FEES_ADDRESS</code> and the accumulated balance. See rewards calculation section.</li><li>The merkle leafs are hashed with solidity <code>sha3</code> hashing algorithm.</li><li>Withdrawal addresses in the merkle tree shall be unique.</li><li>The hashing algorithm for the merkle tree is <code>keccak256</code>.</li><li>The hashing algotithm for the merkle tree shall sort sibling pairs.</li><li>The withdrawal addresses in the merkle tree shall be in lower case.</li></ul><p>Every <code>CHECKPOINT_SIZE_SLOTS</code> the oracle updates in the smoothing pool smart contract stored in the Ethereum blockchain a new merkle root, that summarizes the rewards that each address can claim. Anyone that controls said address, can claim their rewards by providing a valid merkle proof, prooving that a given leaf is contained within the merkle tree represented by that merkle root.</p><p>Since all this data is not available in Ethereum, the oracle shall provide this proofs so that they can be used off-chain. Note that these proofs can be generated by anyone compliying with this specs and with the existing available data on-chain. See <a href="https://ethereum.org/es/developers/tutorials/merkle-proofs-for-offline-data-integrity/" target="_blank" rel="noopener noreferrer">merkle proofs</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="smart-contract">Smart contract<a href="#smart-contract" class="hash-link" aria-label="Direct link to Smart contract" title="Direct link to Smart contract">​</a></h2><p>See <a href="https://github.com/dappnode/mev-sp-contracts" target="_blank" rel="noopener noreferrer">https://github.com/dappnode/mev-sp-contracts</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dappnode/DappnodeDocs/docs/smooth/in-depth-overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/smooth"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Smooth</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/smooth/subscribe-to-smooth/overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Subscribing to Smooth</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuration-parameters" class="table-of-contents__link toc-highlight">Configuration parameters</a></li><li><a href="#smooths-source-of-rewards" class="table-of-contents__link toc-highlight">Smooth&#39;s source of rewards</a></li><li><a href="#subscribeunsubscribeban" class="table-of-contents__link toc-highlight">Subscribe/unsubscribe/ban</a></li><li><a href="#state-machine" class="table-of-contents__link toc-highlight">State machine</a></li><li><a href="#rewards-calculation" class="table-of-contents__link toc-highlight">Rewards calculation</a></li><li><a href="#merkle-trees-and-proofs" class="table-of-contents__link toc-highlight">Merkle trees and proofs</a></li><li><a href="#smart-contract" class="table-of-contents__link toc-highlight">Smart contract</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/user/getting-started/choose-your-path">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/user/staking/overview">Staking</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/user/access-your-dappnode/overview">Access your dappnode</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/dappnode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dappnode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/dappnode" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://dappnode.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dappnode<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Dappnode. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.61229165.js"></script>
<script src="/assets/js/main.a3e4ec34.js"></script>
</body>
</html>